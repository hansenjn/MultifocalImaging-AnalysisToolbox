# MATLAB scripts for MultifocalImaging-AnalysisToolbox
This repository contains matlab scripts for further analysis and visualization of the data produced by the different plugins from the MultifocalImaging-AnalysisToolbox. We also provide example data to test and run the script. More information on how to run the scripts and downloading example data, scroll down to [Description & Examples](https://github.com/hansenjn/MultifocalImaging-AnalysisToolbox/tree/master/Matlab%20scripts#description--examples).

## Copyright and how to cite
Copyright (C) 2016-2021: Luis Alvarez (Contact: luis.alvarez(at)caesar.de)

The scripts belong to the software published along https://doi.org/10.1101/2020.05.16.099390 (see also the [readme file of the main repository](https://github.com/hansenjn/MultifocalImaging-AnalysisToolbox)). Accordingly, when using the matlab scripts presented here, please cite:

Jan N. Hansen, An Gong, Dagmar Wachten, René Pascal, Alex Turpin, Jan F. Jikeli, U. Benjamin Kaupp, Luis Alvarez. Multifocal imaging for precise, label-free tracking of fast biological processes in 3D. bioRxiv 2020.05.16.099390; doi: https://doi.org/10.1101/2020.05.16.099390.

## Dependencies & License Notes
The presented matlab scripts make use of the function mArrow3 from MATLAB central: Georg Stillfried (2021). mArrow3.m - easy-to-use 3D arrow (https://www.mathworks.com/matlabcentral/fileexchange/25372-marrow3-m-easy-to-use-3d-arrow), MATLAB Central File Exchange. Retrieved May 11, 2021.

Some of the presented matlab scripts make use of the function powersmooth from MATLAB central: Benjamin Friedrich (2021). powersmooth (https://www.mathworks.com/matlabcentral/fileexchange/48799-powersmooth), MATLAB Central File Exchange. Retrieved May 12, 2021.

To ensure direct application of the programs presented in this repository, we have copied the matlab scripts *mArrow3.m* and *powersmooth.m* from Matlab central into the repositories where they are applied. We copied the applying licenses as comments into the copied function files.

# Description & Examples
## 1. Estimating x, y, and z precision from statistics of bead displacement
The following programs calculate the tracks of beads based on a text file generated by the ImageJ plugin [MultiFocalParticleTracker-Complex-3](https://github.com/hansenjn/MultiFocalParticleTracker-Complex-3). All required programs can be downloaded [here](https://github.com/hansenjn/MultifocalImaging-AnalysisToolbox/tree/master/Matlab%20scripts/Scripts%203D-PIV%20Diffusion). The example data set to run the programs can be downloaded [here](https://github.com/hansenjn/MultifocalImaging-AnalysisToolbox/tree/master/Matlab%20scripts/Example%203D-PIV%20Diffusion). 

Execute “TracksBuilder.m” to calculate the tracks of individual beads from the text files. The program will generate a Tracks.mat file containing the positions of beads in time and will generate an overview plot of the bead tracks:
<p align="center">
   <img src="https://github.com/hansenjn/MultifocalImaging-AnalysisToolbox/blob/master/Matlab%20scripts/Images%20for%20Readme/Brownian_GlobalView.png" width=680>
   <br>
</p>

After this, run the software “StatisticsBeads.mlx”. This program computes the precision of the multifocal method from the mean squared displacement of the beads and their theoretical diffusion coefficient.
<p align="center">
   <img src="https://github.com/hansenjn/MultifocalImaging-AnalysisToolbox/blob/master/Matlab%20scripts/Images%20for%20Readme/Brownian_StatisticsDisplacementBeads.png" width=300>
   <br>
</p>

## 2. Generating bead tracks and estimating the 3D flow
The following programs calculate the tracks of beads based on the text file with ending *_s.txt* generated by the software [MultiFocalParticleTracker-Complex-3](https://github.com/hansenjn/MultiFocalParticleTracker-Complex-3). All required programs can be downloaded [here](https://github.com/hansenjn/MultifocalImaging-AnalysisToolbox/tree/master/Matlab%20scripts/Scripts%203D-PIV%20Around%20Sperm). To retrieve an example data set, download [this folder](https://github.com/hansenjn/MultifocalImaging-AnalysisToolbox/tree/master/Matlab%20scripts/Example%203D-PIV%20Flow%20Around%20Sperm) and [this exemplary output file from MultiFocalParticleTracker-Complex-3 from figshare](https://doi.org/10.6084/m9.figshare.14587509). Based on these tracks, the flow speed is computed.

The program “Reconstruct_Tracks.m” can be used to plot the overview of all tracks and to display individual tracks. It additionally draws in the background a reference frame with the extracted sperm shape. Tracks are generated based on a number of filters:

**MaxVelocity**: Filter for the particle velocity in µm per s and for connectivity of track positions between frames

**MinTrackDuration**: Number of time points required to keep the track

**MinTrackExtension**:  Start to end extension of the track. This is to avoid non-moving particles

**InterpolateGaps**: Boolean used for interpolation

**MaximalGapLength**: Maximal allowed time gaps (time points where the particle was not detected within range) allowed to connect points to generate tracks.

**PrecissionLimit**: Precision to filter out particle coordinates

<p align="center">
   <img src="https://github.com/hansenjn/MultifocalImaging-AnalysisToolbox/blob/master/Matlab%20scripts/Images%20for%20Readme/PIV-Sperm_SideViewTracks.png" width=480>
   <br>
</p>

As an output of the program, a file (ParticleList.mat) is generated. Run the program “Flow.m” to calculate the flow profile from the particle list.

<p align="center">
   <img src="https://github.com/hansenjn/MultifocalImaging-AnalysisToolbox/blob/master/Matlab%20scripts/Images%20for%20Readme/PIV-Sperm_Rotated_2DFlow_AveragedZ.png" width=800>
   <br>
</p>

## 3. Generating different views of the sperm flagellum
The following programs serve to display the flagellum using different views from the data generated by [SpermQ-MF](https://github.com/hansenjn/SpermQ-MF). 
All required programs can be downloaded [here for human sperm ](https://github.com/hansenjn/MultifocalImaging-AnalysisToolbox/tree/master/Matlab%20scripts/Scripts%20SpermQ-MF%20Human) and [here for sea urchin sperm](https://github.com/hansenjn/MultifocalImaging-AnalysisToolbox/tree/master/Matlab%20scripts/Scripts%20SpermQ-MF%20Sea%20urchin).
An example data set from human sperm can be downloaded [here](https://github.com/hansenjn/MultifocalImaging-AnalysisToolbox/tree/master/Matlab%20scripts/Example%20SpermQ-MF%20Human). An example data set from sea urchin sperm can be downloaded [here](https://github.com/hansenjn/MultifocalImaging-AnalysisToolbox/tree/master/Matlab%20scripts/Example%20SpermQ-MF%20Sea%20urchin).


Three different programs are used for this purpose:

1. “HumanGlobalView.m” (for human sperm) and “SeaUrchinGlobalView.m” (for sea urchin sperm) serve to generate a global view of the sperm flagellum on a lab reference frame. Only one every four flagella are displayed.

<p align="center">
   <i>Human sperm:</i>
   <br>
   <br>
   <img src="https://github.com/hansenjn/MultifocalImaging-AnalysisToolbox/blob/master/Matlab%20scripts/Images%20for%20Readme/HumanSperm_GlobalView.png" width=600>
</p>

<p align="center">
   <i>Sea urchin sperm:</i>
   <br>
   <br>
   <img src="https://github.com/hansenjn/MultifocalImaging-AnalysisToolbox/blob/master/Matlab%20scripts/Images%20for%20Readme/SeaUrchin_GlobalView.png" width=400>
</p>


2. “HumanCloseView.m” (for human sperm) and “SeaUrchinCloseView.m” (for sea urchin sperm) serve to generate a close view of the sperm flagellum on a lab reference frame. All flagella in a short time span are shown.

<p align="center">
   <i>Human sperm:</i>
   <br>
   <br>
   <img src="https://github.com/hansenjn/MultifocalImaging-AnalysisToolbox/blob/master/Matlab%20scripts/Images%20for%20Readme/HumanSperm_CloseView.png" width=400>
</p>

<p align="center">
   <i>Sea urchin sperm:</i>
   <br>
   <br>
   <img src="https://github.com/hansenjn/MultifocalImaging-AnalysisToolbox/blob/master/Matlab%20scripts/Images%20for%20Readme/SeaUrchin_CloseView.png" width=400>
</p>


3. “HumanBackView.m” (for human sperm) and “SeaUrchinBackView.m” (for sea urchin sperm) serve to generate a projection of a single flagellar point to visualize sperm rolling.

<p align="center">
   <i>Human sperm:</i>
   <br>
   <br>
   <img src="https://github.com/hansenjn/MultifocalImaging-AnalysisToolbox/blob/master/Matlab%20scripts/Images%20for%20Readme/HumanSperm_BackView.png" width=600>
</p>

<p align="center">
   <i>Sea urchin sperm:</i>
   <br>
   <br>   
   <img src="https://github.com/hansenjn/MultifocalImaging-AnalysisToolbox/blob/master/Matlab%20scripts/Images%20for%20Readme/SeaUrchin_BackView.png" width=400> 
</p>
